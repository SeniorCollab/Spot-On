<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cesium: Interactive Map with Custom Popup & Editable Pins</title>
    <!-- Cesium CSS -->
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Widgets/widgets.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tron-like font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap">
    <style>
      /* Ensure the whole document and Cesium container are opaque and black */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        font-family: 'Orbitron', sans-serif;
        color: #00ffff;
        overflow: hidden;
      }
      /* Background Video */
      #bgvideo {
        position: fixed;
        top: 0;
        left: 0;
        min-width: 100%;
        min-height: 100%;
        z-index: -2;
        object-fit: cover;
        opacity: 1;
      }
      /* Cesium Container – force an opaque background */
      #cesiumContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        background-color: #000 !important;
      }
      /* Ensure the Cesium canvas remains opaque */
      #cesiumContainer canvas {
        opacity: 1 !important;
      }
      /* Offcanvas Toggle (Hamburger) */
      #offcanvasToggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 20;
        background: transparent;
        border: none;
        outline: none;
      }
      .hamburger-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        z-index: 20;
        position: fixed;
        top: 20px;
        right: 20px;
      }
      .hamburger-icon {
        width: 30px;
        height: 22px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .hamburger-icon span {
        display: block;
        height: 4px;
        width: 100%;
        background-color: #00ffff;
        border-radius: 2px;
        box-shadow: 0 0 5px #00ffff;
      }
      /* Tron-inspired Offcanvas Sidebar */
      .offcanvas {
        background-color: rgba(0, 0, 0, 0.95);
        border-left: 2px solid #00ffff;
      }
      .offcanvas-header,
      .offcanvas-body,
      .offcanvas-title {
        color: #00ffff;
      }
      .offcanvas .nav-link {
        color: #00ffff;
        border-bottom: 1px solid rgba(0, 255, 255, 0.2);
      }
      .offcanvas .nav-link.active {
        background-color: rgba(0, 31, 63, 0.5);
      }
      .offcanvas .nav-link:hover {
        background-color: rgba(0, 31, 63, 0.5);
      }
      /* Tron-style gradient forms and pin popups */
      .blue-gradient-form {
        background: rgba(0, 31, 63, 0.85);
        border: 1px solid #00ffff;
        box-shadow: 0 0 10px #00ffff;
        color: #00ffff;
        padding: 1em;
        border-radius: 10px;
      }
      .pin-popup-content {
        background: rgba(0, 31, 63, 0.9);
        border: 1px solid #00ffff;
        box-shadow: 0 0 10px #00ffff;
        color: #00ffff;
        padding: 1em;
        border-radius: 10px;
        max-width: 300px;
      }
      /* Custom Popup (for our entity click) – fully controlled via CSS */
      #customPopup {
        position: absolute;
        background-color: #111;
        color: #00ffff;
        border: 2px solid #00ffff;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 0 10px #00ffff;
        font-family: 'Orbitron', sans-serif;
        z-index: 100;
        display: none;
        max-width: 300px;
      }
      /* Button Styles */
      .btn {
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-outline-primary,
      .btn-outline-secondary,
      .btn-outline-light {
        border-color: #00ffff;
        color: #00ffff;
      }
      .btn-outline-primary:hover,
      .btn-outline-secondary:hover,
      .btn-outline-light:hover {
        background-color: #00ffff;
        color: #000;
      }
      .btn-warning {
        background-color: #ffaa00;
        border-color: #ffaa00;
        color: #000;
      }
      .btn-warning:hover {
        background-color: #ffcc00;
      }
      .btn-danger {
        background-color: #ff3333;
        border-color: #ff3333;
        color: #000;
      }
      .btn-danger:hover {
        background-color: #ff6666;
      }
      .btn-success {
        background-color: #00ff00;
        border-color: #00ff00;
        color: #000;
      }
      .btn-success:hover {
        background-color: #33ff33;
      }
      /* Embedded Media Elements */
      .pin-iframe,
      .pin-video,
      .pin-audio {
        display: block;
        margin-top: 8px;
        max-width: 100%;
        border: none;
        box-shadow: 0 0 5px #00ffff;
      }
      .pin-iframe {
        height: 150px;
      }
      .pin-image {
        margin-top: 8px;
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        border: 2px solid #00ffff;
        box-shadow: 0 0 5px #00ffff;
      }
    </style>
  </head>
  <body>
    <!-- Background Video -->
    <video autoplay muted loop id="bgvideo">
      <source src="stars.mp4" type="video/mp4">
    </video>

    <!-- Offcanvas Sidebar for Navigation -->
    <button class="hamburger-btn" type="button" id="offcanvasToggle" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
      <div class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>
    <div class="offcanvas offcanvas-end" id="offcanvasNavbar" tabindex="-1">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Spot On</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <nav class="navbar">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="activity.html">View the Pin</a></li>
            <li class="nav-item"><a class="nav-link" href="shop.html">Store</a></li>
            <li class="nav-item"><a class="nav-link" href="guide.html">Instructions</a></li>
            <li class="nav-item"><a class="nav-link" href="testces.html">Test New Globe</a></li>
          </ul>
        </nav>

        <!-- Filter and Logout Buttons -->
        <button class="btn btn-outline-primary w-100 mt-3" id="toggleMyPinsBtn">Show My Pins Only</button>
        <button class="btn btn-danger w-100 mt-3" id="logoutBtn">Log Out</button>

        <!-- Search Pins -->
        <h6 class="mt-4">Search Pins</h6>
        <form id="searchForm">
          <input type="text" class="form-control mb-2" id="searchInput" placeholder="Search by description">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </form>

        <!-- Dedicated Button to Invoke the Pin Modal -->
        <div class="mt-4">
          <h6>Add a Pin</h6>
          <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#pinModal">
            Add Pin via Modal
          </button>
        </div>

        <!-- Offcanvas Form (Manual Entry) for Adding a New Pin -->
        <h6 class="mt-4">Or Add Manually</h6>
        <form id="pinForm" class="blue-gradient-form">
          <div class="mb-2">
            <label for="latitude" class="form-label">Latitude</label>
            <input type="number" class="form-control" id="latitude" required>
          </div>
          <div class="mb-2">
            <label for="longitude" class="form-label">Longitude</label>
            <input type="number" class="form-control" id="longitude" required>
          </div>
          <div class="mb-2">
            <label for="description" class="form-label">Description</label>
            <input type="text" class="form-control" id="description" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Add Pin</button>
        </form>
      </div>
    </div>

    <!-- Cesium Map Container -->
    <div id="cesiumContainer"></div>

    <!-- Custom Popup Element (for entity click) -->
    <div id="customPopup"></div>

    <!-- Main Modal for Pin Creation -->
    <div class="modal fade" id="pinModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: rgba(0,0,0,0.95); border: 1px solid #00ffff;">
          <div class="modal-header">
            <h5 class="modal-title">Add Pin</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="modalChoice" class="text-center">
              <p>Select Pin Type:</p>
              <button class="btn btn-outline-primary mb-2" id="modalBtnSimple">Pin Event</button>
              <button class="btn btn-outline-secondary mb-2" id="modalBtnDetailed">Pin Mood</button>
              <button class="btn btn-outline-success mb-2" id="modalBtnShop">Pin Shop Item</button>
            </div>
            <!-- Event Pin Form -->
            <form id="simpleModalForm" class="d-none blue-gradient-form">
              <label for="modalTitleSimple" class="form-label">Title</label>
              <input type="text" class="form-control mb-2" id="modalTitleSimple" required>
              <label for="modalDescSimple" class="form-label">Description</label>
              <input type="text" class="form-control mb-2" id="modalDescSimple" required>
              <label for="modalSongEvt" class="form-label">Song/Audio/Video Link (Optional)</label>
              <input type="url" class="form-control mb-2" id="modalSongEvt" placeholder="https://...">
              <button type="button" class="btn btn-outline-secondary mb-2" id="uploadEventBtn">Upload Event Image</button>
              <input type="hidden" id="modalImageSimple">
              <label for="modalLatSimple" class="form-label">Latitude</label>
              <input type="number" class="form-control mb-2" id="modalLatSimple" readonly>
              <label for="modalLngSimple" class="form-label">Longitude</label>
              <input type="number" class="form-control mb-2" id="modalLngSimple" readonly>
              <button type="submit" class="btn btn-primary w-100">Save Event Pin</button>
              <button type="button" class="btn btn-link mt-2" id="backFromSimpleModal">← Back</button>
            </form>
            <!-- Mood Pin Form -->
            <form id="detailedModalForm" class="d-none blue-gradient-form">
              <label for="modalTitleDet" class="form-label">Title</label>
              <input type="text" class="form-control mb-2" id="modalTitleDet" required>
              <label for="modalDescDet" class="form-label">Description</label>
              <textarea class="form-control mb-2" id="modalDescDet" rows="2" required></textarea>
              <label for="modalSongDet" class="form-label">Song/Video Link (Optional)</label>
              <input type="url" class="form-control mb-2" id="modalSongDet" placeholder="https://...">
              <label for="modalLatDet" class="form-label">Latitude</label>
              <input type="number" class="form-control mb-2" id="modalLatDet" readonly>
              <label for="modalLngDet" class="form-label">Longitude</label>
              <input type="number" class="form-control mb-2" id="modalLngDet" readonly>
              <button type="submit" class="btn btn-primary w-100">Save Mood Pin</button>
              <button type="button" class="btn btn-link mt-2" id="backFromDetailedModal">← Back</button>
            </form>
            <!-- Shop Pin Form -->
            <form id="shopModalForm" class="d-none blue-gradient-form">
              <label for="modalTitleShop" class="form-label">Title</label>
              <input type="text" class="form-control mb-2" id="modalTitleShop" required>
              <label for="modalDescShop" class="form-label">Description</label>
              <textarea class="form-control mb-2" id="modalDescShop" rows="2" required></textarea>
              <button type="button" class="btn btn-outline-secondary mb-2" id="uploadShopBtn">Upload Shop Image</button>
              <input type="hidden" id="modalImageShop">
              <label for="modalNumberShop" class="form-label">Quantity</label>
              <input type="number" class="form-control mb-2" id="modalNumberShop" placeholder="Quantity" required>
              <label for="modalLinkShop" class="form-label">Link</label>
              <input type="url" class="form-control mb-2" id="modalLinkShop" placeholder="Link" required>
              <label for="modalLatShop" class="form-label">Latitude</label>
              <input type="number" class="form-control mb-2" id="modalLatShop" readonly>
              <label for="modalLngShop" class="form-label">Longitude</label>
              <input type="number" class="form-control mb-2" id="modalLngShop" readonly>
              <button type="submit" class="btn btn-success w-100">Save Shop Item</button>
              <button type="button" class="btn btn-link mt-2" id="backFromShopModal">← Back</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Cesium JS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Cesium.js" crossorigin=""></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase and Custom JavaScript -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import { getDatabase, ref, push, set, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyADk7if-797jFI3Y3IUCnCXFSlOsFmX_3k",
        authDomain: "spoton-cit481.firebaseapp.com",
        databaseURL: "https://spoton-cit481-default-rtdb.firebaseio.com",
        projectId: "spoton-cit481",
        storageBucket: "spoton-cit481.appspot.com",
        messagingSenderId: "753873898041",
        appId: "1:753873898041:web:bde5e8f86aea63b175dbe8"
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      let currentUser = null;
      let eventImageUrl = "";
      let shopImageUrl = "";
      let showOnlyMyPins = false;
      let markersList = [];
      let editingPinId = null;
      let editingPinType = null;

      // Initialize Cesium Viewer with the default infoBox disabled so we can use our own modal popup
      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1ODgwZDk4YS1kNmM2LTQyMmUtYmU4MS00OWUyOTgxYjg3MWMiLCJpZCI6Mjk0MzMxLCJpYXQiOjE3NDQ3MjY5MDN9.GiksKrwslZbSBi62HqVdBBrPQKvSQwF5TT5KmmUPMRQ';
      const bingAerialProvider = new Cesium.IonImageryProvider({ assetId: 2 });
      const ellipsoidTerrain = new Cesium.EllipsoidTerrainProvider();
      const viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: bingAerialProvider,
        terrainProvider: ellipsoidTerrain,
        baseLayerPicker: false,
        animation: false,
        timeline: false,
        infoBox: false
      });
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(-95, 40, 2500000)
      });

      // Set additional scene properties to ensure the globe is visible
      viewer.scene.globe.show = true;
      viewer.scene.globe.translucency.enabled = false;
      viewer.scene.globe.baseColor = Cesium.Color.DARK_GRAY;
      viewer.scene.backgroundColor = Cesium.Color.BLACK;
      viewer.scene.globe.enableLighting = false;

      // Remove the double-click event handler (we now use the dedicated modal button)
      // and remove any other conflicting click handlers if necessary.

      // Custom Popup functions (for when an entity is clicked)
      function showCustomPopup(screenPosition, content) {
        const popup = document.getElementById("customPopup");
        popup.innerHTML = content;
        popup.style.left = (screenPosition.x + 10) + "px";
        popup.style.top = (screenPosition.y + 10) + "px";
        popup.style.display = "block";
      }
      function hideCustomPopup() {
        document.getElementById("customPopup").style.display = "none";
      }

      // Left-click to show custom popup (optional, for viewing entity details)
      const clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
      clickHandler.setInputAction((movement) => {
        const pickedObject = viewer.scene.pick(movement.position);
        if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id)) {
          const content = pickedObject.id.description || "<div>No content</div>";
          showCustomPopup(movement.position, content);
        } else {
          hideCustomPopup();
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // Offcanvas form event for manually adding a new pin
      document.getElementById("pinForm").addEventListener("submit", async e => {
        e.preventDefault();
        const lat = parseFloat(document.getElementById("latitude").value);
        const lon = parseFloat(document.getElementById("longitude").value);
        const description = document.getElementById("description").value;
        // Save as a basic event pin
        await saveEventPin(lat, lon, "Pin", description, "", "");
      });

      // Firebase Authentication check
      onAuthStateChanged(auth, user => {
        if (!user) {
          window.location.href = "user/userlogin.html";
          return;
        }
        currentUser = user;
        loadPinsFromFirebase();
      });

      // Helper to generate embeddable content for media links
      function generateEmbedContent(link) {
        if (!link) return "";
        if (link.includes("open.spotify.com/track/")) {
          const embedUrl = link.replace("open.spotify.com/track/", "open.spotify.com/embed/track/");
          return `<iframe class="pin-iframe" src="${embedUrl}" allow="encrypted-media" allowfullscreen></iframe>`;
        }
        if (link.includes("youtube.com/watch?v=") || link.includes("youtu.be/")) {
          let videoId = "";
          if (link.includes("watch?v=")) {
            videoId = link.split("watch?v=")[1].split("&")[0];
          } else {
            videoId = link.split("youtu.be/")[1];
          }
          const embedUrl = `https://www.youtube.com/embed/${videoId}`;
          return `<iframe class="pin-iframe" src="${embedUrl}" allowfullscreen></iframe>`;
        }
        if (link.endsWith(".mp4")) {
          return `<video class="pin-video" src="${link}" controls></video>`;
        }
        if (link.endsWith(".mp3")) {
          return `<audio class="pin-audio" src="${link}" controls></audio>`;
        }
        return `<iframe class="pin-iframe" src="${link}" allowfullscreen></iframe>`;
      }

      // Function to add a pin (billboard) to Cesium with a custom HTML description
      function addPinCesium(lat, lon, pinData, userId, pinId, pinType) {
        let content = `<div class="pin-popup-content">
          <strong>Title:</strong> ${pinData.title || "Untitled"}<br>
          <strong>Description:</strong> ${pinData.description || ""}`;
        if (pinData.songLink) {
          content += "<br>" + generateEmbedContent(pinData.songLink);
        }
        if (pinData.imageUrl) {
          content += `<br><img class="pin-image" src="${pinData.imageUrl}" alt="Pin Image">`;
        }
        content += `
          <br>
          <button class="btn btn-outline-light btn-sm" onclick="likePin('${userId}','${pinType}','${pinId}')">
            Like (${pinData.likes || 0})
          </button>
          <button class="btn btn-outline-light btn-sm" onclick="dislikePin('${userId}','${pinType}','${pinId}')">
            Dislike (${pinData.dislikes || 0})
          </button>`;
        if (userId === currentUser.uid) {
          content += `
            <br>
            <button class="btn btn-warning btn-sm mt-2" onclick="editPin('${userId}','${pinType}','${pinId}')">Edit</button>
            <button class="btn btn-danger btn-sm mt-2" onclick="deletePin('${userId}','${pinType}','${pinId}')">Delete</button>
          `;
        }
        content += `</div>`;
        const entity = viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(lon, lat),
          billboard: {
            image: 'https://cdn-icons-png.flaticon.com/512/1673/1673221.png',
            scale: 0.075, // Reduced pin size
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM
          },
          label: {
            text: pinData.title || "Untitled",
            font: '14pt sans-serif',
            fillColor: Cesium.Color.WHITE,
            outlineColor: Cesium.Color.BLACK,
            outlineWidth: 2,
            verticalOrigin: Cesium.VerticalOrigin.TOP,
            pixelOffset: new Cesium.Cartesian2(0, -30)
          },
          description: content
        });
        return entity;
      }

      // Load pins from Firebase and add them to Cesium
      function loadPinsFromFirebase() {
        markersList.forEach(entity => viewer.entities.remove(entity));
        markersList = [];
        const path = showOnlyMyPins ? `pins/${currentUser.uid}` : "pins";
        onValue(ref(db, path), snapshot => {
          markersList.forEach(entity => viewer.entities.remove(entity));
          markersList = [];
          const data = snapshot.val();
          if (!data) return;
          if (showOnlyMyPins) {
            loadUserPinTypes(currentUser.uid, data);
          } else {
            Object.entries(data).forEach(([userId, userData]) => {
              loadUserPinTypes(userId, userData);
            });
          }
        });
      }
      function loadUserPinTypes(userId, userData) {
        ["eventPins", "moodPins", "shopPins"].forEach(pinType => {
          const group = userData[pinType];
          if (!group) return;
          Object.entries(group).forEach(([pinId, pin]) => {
            if (pin.geolocation) {
              const entity = addPinCesium(pin.geolocation.lat, pin.geolocation.lng, pin, userId, pinId, pinType);
              markersList.push(entity);
            }
          });
        });
      }

      // Global functions for interactive actions – accessible from popup buttons
      window.likePin = async function(userId, pinType, pinId) {
        const pinRef = ref(db, `pins/${userId}/${pinType}/${pinId}`);
        const snapshot = await get(pinRef);
        if (snapshot.exists()) {
          const pinData = snapshot.val();
          const currentLikes = pinData.likes || 0;
          await update(pinRef, { likes: currentLikes + 1 });
        }
      };
      window.dislikePin = async function(userId, pinType, pinId) {
        const pinRef = ref(db, `pins/${userId}/${pinType}/${pinId}`);
        const snapshot = await get(pinRef);
        if (snapshot.exists()) {
          const pinData = snapshot.val();
          const currentDislikes = pinData.dislikes || 0;
          await update(pinRef, { dislikes: currentDislikes + 1 });
        }
      };
      window.deletePin = async function(userId, pinType, pinId) {
        if (userId === currentUser.uid && confirm("Are you sure you want to delete this pin?")) {
          const pinRef = ref(db, `pins/${userId}/${pinType}/${pinId}`);
          await remove(pinRef);
          loadPinsFromFirebase();
        }
      };
      window.editPin = async function(userId, pinType, pinId) {
        const pinRef = ref(db, `pins/${userId}/${pinType}/${pinId}`);
        const snapshot = await get(pinRef);
        if (!snapshot.exists()) return;
        const pinData = snapshot.val();
        editingPinId = pinId;
        editingPinType = pinType;
        if (pinType === "eventPins") {
          document.getElementById("modalTitleSimple").value = pinData.title || "";
          document.getElementById("modalDescSimple").value = pinData.description || "";
          document.getElementById("modalSongEvt").value = pinData.songLink || "";
          document.getElementById("modalLatSimple").value = pinData.geolocation.lat;
          document.getElementById("modalLngSimple").value = pinData.geolocation.lng;
          eventImageUrl = pinData.imageUrl || "";
          hideForms();
          document.getElementById("simpleModalForm").classList.remove("d-none");
        } else if (pinType === "moodPins") {
          document.getElementById("modalTitleDet").value = pinData.title || "";
          document.getElementById("modalDescDet").value = pinData.description || "";
          document.getElementById("modalSongDet").value = pinData.songLink || "";
          document.getElementById("modalLatDet").value = pinData.geolocation.lat;
          document.getElementById("modalLngDet").value = pinData.geolocation.lng;
          hideForms();
          document.getElementById("detailedModalForm").classList.remove("d-none");
        } else if (pinType === "shopPins") {
          document.getElementById("modalTitleShop").value = pinData.title || "";
          document.getElementById("modalDescShop").value = pinData.description || "";
          document.getElementById("modalNumberShop").value = pinData.quantity || "";
          document.getElementById("modalLinkShop").value = pinData.link || "";
          document.getElementById("modalLatShop").value = pinData.geolocation.lat;
          document.getElementById("modalLngShop").value = pinData.geolocation.lng;
          shopImageUrl = pinData.imageUrl || "";
          hideForms();
          document.getElementById("shopModalForm").classList.remove("d-none");
        }
        const pinModalEl = document.getElementById("pinModal");
        const modal = new bootstrap.Modal(pinModalEl);
        modal.show();
      };
      async function updatePin(pinType, pinId, updatedData) {
        const pinRef = ref(db, `pins/${currentUser.uid}/${pinType}/${pinId}`);
        return update(pinRef, updatedData);
      }

      // Cloudinary upload handler (assumes Cloudinary widget is available)
      function openCloudinary(callback) {
        cloudinary.createUploadWidget({
          cloudName: "djhoct1eh",
          uploadPreset: "ml_default"
        }, (err, result) => {
          if (!err && result && result.event === "success") {
            callback(result.info.secure_url);
          }
        }).open();
      }
      document.getElementById("uploadEventBtn").addEventListener("click", () => {
        openCloudinary(url => {
          eventImageUrl = url;
          alert("Event image uploaded");
        });
      });
      document.getElementById("uploadShopBtn").addEventListener("click", () => {
        openCloudinary(url => {
          shopImageUrl = url;
          alert("Shop image uploaded");
        });
      });

      // Modal navigation buttons
      document.getElementById("modalBtnSimple").onclick = () => {
        hideForms();
        document.getElementById("simpleModalForm").classList.remove("d-none");
      };
      document.getElementById("modalBtnDetailed").onclick = () => {
        hideForms();
        document.getElementById("detailedModalForm").classList.remove("d-none");
      };
      document.getElementById("modalBtnShop").onclick = () => {
        hideForms();
        document.getElementById("shopModalForm").classList.remove("d-none");
      };
      document.getElementById("backFromSimpleModal").onclick =
        document.getElementById("backFromDetailedModal").onclick =
        document.getElementById("backFromShopModal").onclick = () => {
          hideForms();
          document.getElementById("modalChoice").classList.remove("d-none");
        };
      function hideForms() {
        ["modalChoice", "simpleModalForm", "detailedModalForm", "shopModalForm"]
          .forEach(id => document.getElementById(id).classList.add("d-none"));
      }

      // Modal form submissions
      document.getElementById("simpleModalForm").addEventListener("submit", async e => {
        e.preventDefault();
        const lat = parseFloat(document.getElementById("modalLatSimple").value);
        const lon = parseFloat(document.getElementById("modalLngSimple").value);
        const title = document.getElementById("modalTitleSimple").value;
        const desc = document.getElementById("modalDescSimple").value;
        const songLink = document.getElementById("modalSongEvt").value;
        if (editingPinId && editingPinType === "eventPins") {
          await updatePin("eventPins", editingPinId, {
            title,
            description: desc,
            imageUrl: eventImageUrl,
            songLink,
            geolocation: { lat, lng: lon }
          });
        } else {
          await saveEventPin(lat, lon, title, desc, eventImageUrl, songLink);
        }
        eventImageUrl = "";
        editingPinId = null;
        editingPinType = null;
        document.getElementById("pinModal").querySelector(".btn-close").click();
      });
      document.getElementById("detailedModalForm").addEventListener("submit", async e => {
        e.preventDefault();
        const lat = parseFloat(document.getElementById("modalLatDet").value);
        const lon = parseFloat(document.getElementById("modalLngDet").value);
        const title = document.getElementById("modalTitleDet").value;
        const desc = document.getElementById("modalDescDet").value;
        const songLink = document.getElementById("modalSongDet").value;
        if (editingPinId && editingPinType === "moodPins") {
          await updatePin("moodPins", editingPinId, {
            title,
            description: desc,
            songLink,
            geolocation: { lat, lng: lon }
          });
        } else {
          await saveMoodPin(lat, lon, title, desc, songLink);
        }
        editingPinId = null;
        editingPinType = null;
        document.getElementById("pinModal").querySelector(".btn-close").click();
      });
      document.getElementById("shopModalForm").addEventListener("submit", async e => {
        e.preventDefault();
        const lat = parseFloat(document.getElementById("modalLatShop").value);
        const lon = parseFloat(document.getElementById("modalLngShop").value);
        const title = document.getElementById("modalTitleShop").value;
        const desc = document.getElementById("modalDescShop").value;
        const quantity = document.getElementById("modalNumberShop").value;
        const link = document.getElementById("modalLinkShop").value;
        if (editingPinId && editingPinType === "shopPins") {
          await updatePin("shopPins", editingPinId, {
            title,
            description: desc,
            imageUrl: shopImageUrl,
            quantity,
            link,
            geolocation: { lat, lng: lon }
          });
        } else {
          await saveShopPin(lat, lon, title, desc, shopImageUrl, quantity, link);
        }
        shopImageUrl = "";
        editingPinId = null;
        editingPinType = null;
        document.getElementById("pinModal").querySelector(".btn-close").click();
      });

      // Functions to save new pins to Firebase
      function saveEventPin(lat, lng, title, desc, imageUrl = "", songLink = "") {
        const refPath = ref(db, `pins/${currentUser.uid}/eventPins`);
        return set(push(refPath), {
          title,
          description: desc,
          imageUrl,
          songLink,
          likes: 0,
          dislikes: 0,
          geolocation: { lat, lng },
          timestamp: Date.now()
        });
      }
      function saveMoodPin(lat, lng, title, desc, songLink = "") {
        const refPath = ref(db, `pins/${currentUser.uid}/moodPins`);
        return set(push(refPath), {
          title,
          description: desc,
          songLink,
          likes: 0,
          dislikes: 0,
          geolocation: { lat, lng },
          timestamp: Date.now()
        });
      }
      function saveShopPin(lat, lng, title, desc, imageUrl = "", quantity, link) {
        const refPath = ref(db, `pins/${currentUser.uid}/shopPins`);
        return set(push(refPath), {
          title,
          description: desc,
          imageUrl,
          quantity,
          link,
          likes: 0,
          dislikes: 0,
          geolocation: { lat, lng },
          timestamp: Date.now()
        });
      }
    </script>
  </body>
</html>










